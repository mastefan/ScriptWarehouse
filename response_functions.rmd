---
title: "response_functions"
author: "Mike Stefanuk"
date: "October 5, 2018"
output: word_document
---

Response functions will be identified for the relationship between tree ring chronologies and climate variables.

This code should be run after chronologies_v3.rmd

Stages:

1 - Load chronology and climate data

2 - Prepare data for use by treeclim:: functions

3 - Response fucntion analysis (stationary)

4 - Response function analysis (moving window)

5 - Seasonal partial correlation

---

```{r s0 set seed, echo = FALSE}

set.seed(2016)

```

---

1 - Load chronology and climate data

```{r s1 file paths, echo = FALSE}

# chronologies
crn_p <- "D:/Dropbox/Queen's/Thesis/Chronologies/MasterChronologies"

# climate
cli_p <- "D:/Processing/point_climate"

```

```{r s1 load chronology data, echo = FALSE}

# master
mas <- tibble::column_to_rownames(read.csv(sprintf("%s/master.csv", crn_p)), "X")

# split to individual variables
alg.crn <- dplyr::select(mas, "alg")
fro.crn <- dplyr::select(mas, "fro")
adk.crn <- dplyr::select(mas, "adk")

# cleanup
rm(mas)

```

```{r s1 load cliamte, echo = FALSE}

# make lists of climate variables as dataframes within sub-list
alg.cli <- list(tmx = read.csv(sprintf("%s/algonquin_tmx.csv", cli_p))[,1:13],
                tme = read.csv(sprintf("%s/algonquin_tme.csv", cli_p))[,1:13],
                tmn = read.csv(sprintf("%s/algonquin_tmn.csv", cli_p))[,1:13],
                prt = read.csv(sprintf("%s/algonquin_prt.csv", cli_p))[,1:13],
                s18 = read.csv(sprintf("%s/algonquin_SPEI_18.csv", cli_p)))
fro.cli <- list(tmx = read.csv(sprintf("%s/frontenac_tmx.csv", cli_p))[,1:13],
                tme = read.csv(sprintf("%s/frontenac_tme.csv", cli_p))[,1:13],
                tmn = read.csv(sprintf("%s/frontenac_tmn.csv", cli_p))[,1:13],
                prt = read.csv(sprintf("%s/frontenac_prt.csv", cli_p))[,1:13],
                s18 = read.csv(sprintf("%s/frontenac_SPEI_18.csv", cli_p)))
adk.cli <- list(tmx = read.csv(sprintf("%s/adirondack_tmx.csv", cli_p))[,1:13],
                tme = read.csv(sprintf("%s/adirondack_tme.csv", cli_p))[,1:13],
                tmn = read.csv(sprintf("%s/adirondack_tmn.csv", cli_p))[,1:13],
                prt = read.csv(sprintf("%s/adirondack_prt.csv", cli_p))[,1:13],
                s18 = read.csv(sprintf("%s/adirondack_SPEI_18.csv", cli_p)))

```

---

2 - Prepare data for use by treeclim:: functions

Data formatting requirements:

- chronologies as would be output by dplR::chron (year as rowname, value in column)

- climate as (optionally) named list of 13 column dataframes (year, monthly data * 12)

- no missing climate data is permitted

```{r s2 infinite value correction, echo = FALSE}

# fix Inf value in adirondacks SPEI
adk.cli[[5]][adk.cli[[5]] == Inf] <- NA

```

```{r s2 filling missing climate data, echo = FALSE}

# function to fill missing values based on a univariate time series of climate data
unifill <- function(dat){
  a <- reshape2::melt(data = dat, id = "X") # convert to long format
  if(sum(is.na(a$value)) > 0){ # if there are NA's in the series run the filler
    a$variable <- as.numeric(a$variable) # convert months to numeric
    a$Date <- as.Date(paste(a$X, a$variable, "01", sep = "-"), 
                      format = ("%Y-%m-%d")) # create date column
    a <- a[order(a$Date),] # put data in chronological order
    t <- ts(a$value, start = c(as.numeric(format(a$Date[1], "%Y")), 1), 
            end = c(as.numeric(format(a$Date[length(a$Date)], "%Y")),12), frequency = 12) # create time series object
    if(is.na(t[1])){
      t[1] <- median(dat[,2], na.rm = TRUE) # assign first value to monthny median if missing, as zoo::na.StrucTS does not tolerate this
    }
    t <- zoo::na.StructTS(t) # run correction using seasonal Kalman filter and fixed-interval smoothing
    b <- a[,1:3] # get all columns except Date
    b$value <- round(as.numeric(t), 2) # assign filled timeseries values to new dataframe
    b <- reshape(data = b, idvar = "X", timevar = "variable", direction = "wide") # convert back to wide format
    colnames(b) <- colnames(dat) # assign original column names to output
    return(b) # return result
  } else { # if there are no NA's, return the input
    return(dat)
  }
}

# apply to climate lists
alg.cli <- lapply(X = alg.cli, FUN = unifill)
fro.cli <- lapply(X = fro.cli, FUN = unifill)
adk.cli <- lapply(X = adk.cli, FUN = unifill)

# cleanup
rm(unifill)

```

NA values filled using zoo::na.StrucTS:

- uses seasonal Kalman filter & fixed-interval smoothing

- found to be effective for seasonal data with trends in https://arxiv.org/ftp/arxiv/papers/1510/1510.03924.pdf


Temporal autoregression (and trends) must be removed from climate data for proper analysis

This will be done using standization and prewhitening (for SPEI)

SPEI data will be prewhitened to remove any trends in the data

```{r s2 prewhiten SPEI, echo = FALSE}

# prewhitening function
prewhiten <- function(dat, ARmax = 2){
  wrk <- reshape2::melt(dat, id = "X") # convert to long format
  wrk$variable <- as.numeric(wrk$variable) # months to numeric
  wrk$ID <- paste(wrk$X, wrk$variable, "01", sep = "-") # create ID variable
  wrk$ID <- as.Date(wrk$ID, format = "%Y-%m-%d") # convert ID to date
  wrk <- wrk[order(wrk$ID),] # put data in chronological order
  t <- data.frame(ID = seq(from = min(wrk$ID), to = max(wrk$ID), by = "year")) # create full date sequence for data
  wrk <- suppressMessages(dplyr::full_join(x = t, y = wrk)) # join full series to dataset to ensure that timeseries is complete
  wrk <- wrk[order(wrk$ID),] # put data in chronological order
  wrk.ts <- ts(wrk$value, 
               start = c(lubridate::year(min(wrk$ID)), lubridate::month(min(wrk$ID))), 
               end   = c(lubridate::year(max(wrk$ID)), lubridate::month(max(wrk$ID))), 
               frequency = 12) # create wroking timeseries
  out.ts <- psd::prewhiten(tser = wrk.ts,
                           AR.max = ARmax, 
                           impute = T,
                           verbose = FALSE, 
                           plot = FALSE)$prew_ar # prewhiten, removing autoregressive persistence
  
  out <- data.frame(X = wrk$X, variable = wrk$variable, value = as.numeric(out.ts)) # construct long output
  out <- reshape(data = out, idvar = "X", timevar = "variable", direction = "wide") # convert to wide format
  colnames(out) <- colnames(dat) # assign original column names
  return(out) # return result
}

# prewhiten SPEI
alg.cli[["s18"]] <- prewhiten(alg.cli[["s18"]], ARmax = 1)
fro.cli[["s18"]] <- prewhiten(fro.cli[["s18"]], ARmax = 1)
adk.cli[["s18"]] <- prewhiten(adk.cli[["s18"]], ARmax = 1)

# cleanup
rm(prewhiten)

```

Climate data will be standardized to:

- have a mean of 0

- have a standard deviation of 1

```{r s2 scaling, echo = FALSE}

# function to work with this format (not scale years), whould work within lapply
noy <- function(dat){
  wrk <- data.frame(dat[,2:13]) # remove year data from working dataset
  wrk <- as.data.frame(scale(wrk, center = TRUE, scale = TRUE), stringsAsFactors = FALSE) # center and scale
  out <- data.frame(X = dat[,1], wrk, row.names = NULL) # create output with row names
  return(out) # return result
}

## isolate SPEI data
#alg.spei <- alg.cli[[5]]
#fro.spei <- fro.cli[[5]]
#adk.spei <- adk.cli[[5]]

# center and scale climate data
alg.cli <- lapply(X = alg.cli, FUN = noy)
fro.cli <- lapply(X = fro.cli, FUN = noy)
adk.cli <- lapply(X = adk.cli, FUN = noy)

## replace SPEI data in lists
#alg.cli[[5]] <- alg.spei
#fro.cli[[5]] <- fro.spei
#adk.cli[[5]] <- adk.spei

# cleanup
rm(noy); rm(list = ls(pattern = ".spei"))

```

Note that SPEI data are scaled by default, but they were rescaled after prewhitening as the sd nolonger equals 1

Centering and scaling creates a dataset that:

- has a SD of 1

- had a mean of 1

- it appears that the order of operations for the scale function centers (mean = 0) then scales (sd = 1), therefore the mean shifts

- the mean shift is by a matter of thousandths at the most, so the mean is effectively 0

- these results are identical to (x - mean(x)) / sd(x), and therefore I assume that they are effective

---

3 - Response fucntion analysis (stationary)

First, the window should be set:

- 1894 (Adirondack prt min + 1) to 2011

Old - 1890 to 2011 (mirroring max window from productivity trend analysis)


```{r s3 window}

t.s <- c(1894, 2011)

```

Below are the stationary response functions for:

- January to October of the year of growth


```{r s3 Jan to Oct current, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = c(1:10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = c(1:10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = c(1:10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- January to October of the previous year to the year of growth


```{r s3 Jan to Oct lagged, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = c(-1:-10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = c(-1:-10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = c(-1:-10), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
```

- June to October for the year of growth and previous year


```{r s3 June to Oct current and lagged, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::exclude_from(c(-6:10), 
                                                              exclude = c(-11,-12,1:5)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::exclude_from(c(-6:10), 
                                                              exclude = c(-11,-12,1:5)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::exclude_from(c(-6:10), 
                                                              exclude = c(-11,-12,1:5)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- January of the previous year to October of the year of growth by a 3 year moving window (following Bishop 2015)

Note that tests were done (not included) to see whether there was a difference between results from RFA with the PCA and mean chronologies. There were very slight differences in the 'shape' of the plots, but no compelling reason was found to use one chronology or the other.


```{r s3 Bishop, echo = FALSE}

# create selection list
set <- treeclim::.mean(.months = -1:-3,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -2:-4,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -3:-5,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -4:-6,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -5:-7,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -6:-8,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -7:-9,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -8:-10,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -9:-11,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -10:-12,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -11:1,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -12:2,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 1:3,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 2:4,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 3:5,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 4:6,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 5:7,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 6:8,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 7:9,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 8:10,
                       .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.sum(.months = -1:-3,
                      .variables = "prt") + 
       treeclim::.sum(.months = -2:-4,
                      .variables = "prt") + 
       treeclim::.sum(.months = -3:-5,
                      .variables = "prt") + 
       treeclim::.sum(.months = -4:-6,
                      .variables = "prt") + 
       treeclim::.sum(.months = -5:-7,
                      .variables = "prt") + 
       treeclim::.sum(.months = -6:-8,
                      .variables = "prt") + 
       treeclim::.sum(.months = -7:-9,
                      .variables = "prt") + 
       treeclim::.sum(.months = -8:-10,
                      .variables = "prt") + 
       treeclim::.sum(.months = -9:-11,
                      .variables = "prt") + 
       treeclim::.sum(.months = -10:-12,
                      .variables = "prt") + 
       treeclim::.sum(.months = -11:1,
                      .variables = "prt") + 
       treeclim::.sum(.months = -12:2,
                      .variables = "prt") + 
       treeclim::.sum(.months = 1:3,
                      .variables = "prt") + 
       treeclim::.sum(.months = 2:4,
                      .variables = "prt") + 
       treeclim::.sum(.months = 3:5,
                      .variables = "prt") + 
       treeclim::.sum(.months = 4:6,
                      .variables = "prt") + 
       treeclim::.sum(.months = 5:7,
                      .variables = "prt") + 
       treeclim::.sum(.months = 6:8,
                      .variables = "prt") + 
       treeclim::.sum(.months = 7:9,
                      .variables = "prt") + 
       treeclim::.sum(.months = 8:10,
                      .variables = "prt")

# run calculations

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = set, 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = set, 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = set, 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

![Bishop figure for reference](D:/Dropbox/Queen's/Thesis/Chronologies/BishopCorrelation.jpg)


- Current and lagged spring (April, May and June)


```{r s3 spring monthly, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::exclude_from(c(-4:6), 
                                                              exclude = c(-1:-3,-7:-12,1:3,7:12)),
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::exclude_from(c(-4:6), 
                                                              exclude = c(-1:-3,-7:-12,1:3,7:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::exclude_from(c(-4:6), 
                                                              exclude = c(-1:-3,-7:-12,1:3,7:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- Current and lagged spring (3 month mean)

```{r s3 spring mean, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::.mean(.months = c(-4:-6)) + 
                                       treeclim::.mean(.months = c(4:6)),
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::.mean(.months = c(-4:-6)) + 
                                       treeclim::.mean(.months = c(4:6)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::.mean(.months = c(-4:-6)) + 
                                       treeclim::.mean(.months = c(4:6)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- Current and lagged summer (July and August)


```{r s3 summer monthly, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::exclude_from(c(-7:8), 
                                                              exclude = c(-1:-6,-9:-12,1:6,9:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::exclude_from(c(-7:8), 
                                                              exclude = c(-1:-6,-9:-12,1:6,9:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::exclude_from(c(-7:8), 
                                                              exclude = c(-1:-6,-9:-12,1:6,9:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- Current and lagged summer (2 month mean)

```{r s3 summer mean, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- Current and lagged autumn (September and October)


```{r s3 autumn monthly, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::exclude_from(c(-9:10), 
                                                              exclude = c(-1:-8,-11:-12,1:8,11:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::exclude_from(c(-9:10), 
                                                              exclude = c(-1:-8,-11:-12,1:8,11:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::exclude_from(c(-9:10), 
                                                              exclude = c(-1:-8,-11:-12,1:8,11:12)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

- Current and lagged autumn (2 month mean)


```{r s3 autumn mean, eval=FALSE, include=FALSE}

alg.res.s <- treeclim::dcc(chrono = alg.crn, climate = alg.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(alg.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

fro.res.s <- treeclim::dcc(chrono = fro.crn, climate = fro.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(fro.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

adk.res.s <- treeclim::dcc(chrono = adk.crn, climate = adk.cli,
                           selection = treeclim::.mean(.months = c(-7:-8)) + 
                                       treeclim::.mean(.months = c(7:8)), 
                           method = "response", boot = "std", 
                           timespan = t.s, ci = 0.05)
plot(adk.res.s) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))

```

```{r s3 cleanup, echo = FALSE}
rm(list = ls(pattern = ".s"))
```

---

4 - Response function analysis (moving window)

```{r s4 window}
t.s <- c(1894, 2011)
```

The selection of the treeclim::dcc function for "moving" seems to be limited by window size

The formula for max allowed window size seems to be:

- number of climate variables * number of 'months'

Doing a moving window analysis with the resolution of the stationary analysis is therefore impossible

Window size will be manipulated to give the greatest perspective possible

```{r s4 moving window 1}

# set window offset (yrs)
w.o <- 5

# set window size (yrs)
w.s <- 20

```

Below are the moving response functions for:

- Spring and Summer of the current and lagged year of growth

```{r s4 spring and summer, echo=FALSE}

alg.res.m <- treeclim::dcc(chrono = alg.crn, climate = alg.cli, 
                           selection = treeclim::.mean(.months = -3:-5) + 
                                       treeclim::.mean(.months = -6:-8) + 
                                       treeclim::.mean(.months = 3:-5) + 
                                       treeclim::.mean(.months = 6:8),  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Algonquin"); treeclim::traceplot(alg.res.m)

fro.res.m <- treeclim::dcc(chrono = fro.crn, climate = fro.cli, 
                           selection = treeclim::.mean(.months = -3:-5) + 
                                       treeclim::.mean(.months = -6:-8) + 
                                       treeclim::.mean(.months = 3:-5) + 
                                       treeclim::.mean(.months = 6:8),  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Frontenac"); treeclim::traceplot(fro.res.m)

adk.res.m <- treeclim::dcc(chrono = adk.crn, climate = adk.cli, 
                           selection = treeclim::.mean(.months = -3:-5) + 
                                       treeclim::.mean(.months = -6:-8) + 
                                       treeclim::.mean(.months = 3:-5) + 
                                       treeclim::.mean(.months = 6:8),  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Adirondack"); treeclim::traceplot(adk.res.m)

```

- January of the previous year to October of the year of growth (non-overlapping seasonal means) (following Bishop 2015)

```{r s4 moving window 2}

# set window offset (yrs)
w.o <- 5

# set window size (yrs)
w.s <- 40

```

```{r s4 seasonal means, echo = FALSE}

# create selection

set <- treeclim::.mean(.months = -1:-2, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -3:-5, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -6:-8, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -9:-11, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = -12:2, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 3:5, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 6:8, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.mean(.months = 9:10, .variables = c("tmx", "tme", "tmn", "s18")) + 
       treeclim::.sum(.months = -1:-2, .variables = "prt") + 
       treeclim::.sum(.months = -3:-5, .variables = "prt") + 
       treeclim::.sum(.months = -6:-8, .variables = "prt") + 
       treeclim::.sum(.months = -9:-11, .variables = "prt") + 
       treeclim::.sum(.months = -12:2, .variables = "prt") + 
       treeclim::.sum(.months = 3:5, .variables = "prt") + 
       treeclim::.sum(.months = 6:8, .variables = "prt") + 
       treeclim::.sum(.months = 9:10, .variables = "prt")

# run calculations

alg.res.m <- treeclim::dcc(chrono = alg.crn, climate = alg.cli, 
                           selection = set,  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Algonquin"); treeclim::traceplot(alg.res.m)

fro.res.m <- treeclim::dcc(chrono = fro.crn, climate = fro.cli, 
                           selection = set,  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Frontenac"); treeclim::traceplot(fro.res.m)

adk.res.m <- treeclim::dcc(chrono = adk.crn, climate = adk.cli, 
                           selection = set,  
                           win_offset = w.o, win_size = w.s,
                           method = "response", boot = "std", 
                           sb = FALSE, 
                           timespan = t.s,
                           dynamic = "moving")
print("Adirondack"); treeclim::traceplot(adk.res.m)

```

```{r s4 cleanup, echo = FALSE}
rm(list = ls(pattern = ".m")); rm(set, w.o, w.s, t.s)
```

---

5 - Seasonal partial correlation

```{r s5 window}
t.s <- c(1894, 2011)
```

```{r s5 variables}

# set primary variable
pri <- "tmx"

# set secondary variable
sec <- "tmn"

```

```{r s5 prt vs tme, echo = FALSE}

alg.sea <- treeclim::seascorr(chrono = alg.crn, climate = alg.cli,
                              timespan = t.s, complete = 10,
                              season_lengths = c(1, 3, 6),
                              primary = pri, secondary = sec,
                              ci = 0.05)
print("Algonquin"); plot(alg.sea)

fro.sea <- treeclim::seascorr(chrono = fro.crn, climate = fro.cli,
                              timespan = t.s, complete = 10,
                              season_lengths = c(1, 3, 6),
                              primary = pri, secondary = sec,
                              ci = 0.05)
print("Frontenac"); plot(fro.sea)

adk.sea <- treeclim::seascorr(chrono = adk.crn, climate = adk.cli,
                              timespan = t.s, complete = 10,
                              season_lengths = c(1, 3, 6),
                              primary = pri, secondary = sec,
                              ci = 0.05)
print("Adirondack"); plot(adk.sea)

```

```{r s5 cleanup, echo = FALSE}
rm(pri, sec, t.s); rm(list = ls(pattern = ".sea"))
```

---

Deprecated code kept for reference

```{r deprecated climate reformat, eval=FALSE, include=FALSE}

### DEPRECATED ###

alg.cli.2 <- lapply(X = alg.cli, FUN = reshape2::melt, id = "X", na.rm = FALSE) # convert to long format
alg.cli.2 <- lapply(X = alg.cli.2, FUN = function(x){x[,2] <- as.numeric(x[,2]); return(x)}) # convert months to numeric for conversion to date
alg.cli.2 <- lapply(X = alg.cli.2, FUN = dplyr::mutate, ID = paste(X, variable, "01", sep = "-") , na.rm = FALSE) # create ID for merge
alg.cli.2 <- lapply(X = alg.cli.2, FUN = function(x){x[,4] <- as.Date(x[,4], "%Y-%m-%d"); return(x)}) # convert ID to date
alg.cli.2 <- lapply(X = alg.cli.2, FUN = dplyr::select, c(ID, value)) # remove all but value and ID
alg.cli.2 <- lapply(X = alg.cli.2, FUN = function(x){return(x[order(x$ID),])}) # put data in chronological order
for(i in 1:length(alg.cli.2)){
  colnames(alg.cli.2[[i]]) <- c("ID", names(alg.cli.2[i])) # name value columns
}
for(i in 2:length(alg.cli.2)){ # convert list data to dataframe
  if(i == 2){
    alg.cli.3 <- suppressMessages(dplyr::full_join(x = alg.cli.2[[1]], y = alg.cli.2[[2]]))
  } else {
    alg.cli.3 <- suppressMessages(dplyr::full_join(x = alg.cli.3, y = alg.cli.2[[i]]))
  }
}
t <- data.frame(ID = seq(from = min(alg.cli.3$ID), max(alg.cli.3$ID), by = "month")) # create full set of months
alg.cli.3 <- suppressMessages(dplyr::full_join(x = t, y = alg.cli.3)) # create full dataset
alg.cli.4 <- data.frame(Year = lubridate::year(alg.cli.3$ID), 
                        Month = lubridate::month(alg.cli.3$ID)) # create Year and Month columns
alg.cli.4 <- cbind(alg.cli.4, alg.cli.3[,-1]) # create final dataframe


# cleanup
rm(t,i)
alg.cli.2 <- alg.cli.4
rm(alg.cli.3, alg.cli.4)

```
